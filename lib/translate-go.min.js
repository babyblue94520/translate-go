var TranslateModule=function(e){"use strict";function t(){return window[s.Prefix]?window[s.Prefix]:window[s.Prefix]=new c}var r=function(){};r.getParentElement=function(e){return void 0!=e.parentElement?e.parentElement:void 0!=e.parentNode?e.parentNode:void 0},r.isConnected=function(e){if(!e)return!1;if(void 0==e.isConnected){var t=r.getParentElement(e);return!!t&&(e==document.body||t==document.body||r.isConnected(t))}return e.isConnected};var n=function(){this._nodes=[]};n.prototype.indexOf=function(e){return this._nodes.indexOf(e)},n.prototype.getNodes=function(){return this._nodes},n.prototype.add=function(e){this._nodes.push(e)},n.prototype.remove=function(e){var t=this.indexOf(e);return-1!=t&&(this._nodes.splice(t,1),!0)},n.prototype.clean=function(){this._nodes=this._nodes.filter(r.isConnected)};var o=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.need=function(e){return void 0!=e.placeholder||""!=e.placeholder},t.prototype.getText=function(e){return e.placeholder},t.prototype.setText=function(e,t){t&&(e.placeholder=t)},t}(n),a=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.need=function(e){return 3==e.nodeType},t.prototype.getText=function(e){return e.data},t.prototype.setText=function(e,t){t&&(e.data=t)},t}(n),i={production:!1},s={Repeat:"repeat",Type:"type",Key:"key",IgnoreKeyArray:["key","type","repeat"],IgnoreTagArray:["SCRIPT","LINK","META","STYLE"],IgnoreAttributeName:"nottranslate",Translatekey:"translatekey",PlaceholderTranslatekey:"placeholdertranslatekey",Placeholder:"placeholder",Prefix:"__translateGO",GroupPrefix:"__translateGO_",ConfigPrefix:"__translateGOConfig"};console.log("TranslateConst.ConfigPrefix",window[s.ConfigPrefix]),void 0==window[s.ConfigPrefix]&&(window[s.ConfigPrefix]={dev:!i.production,defaultLanguage:"en"});var d,u=window[s.ConfigPrefix];!function(e){e[e.none=0]="none",e[e.key=1]="key"}(d||(d={}));var l=function(){this._specialChars="[.。:：;；!！?？{}()=＊*\\[\\]\\s\\r\\n]",this._startRegexStr="(^[{(＊*\\[\\s\\r\\n]?)",this._endRegexStr="([.。:：;；!！?？=＊*\\]\\s\\r\\n]?$)",this._cleanChars="[\\r\\n]",this._modifier="i",this._cleanRegex=new RegExp(this._cleanChars+"+","g"),this._textReplaceSpecialCharsRegex=new RegExp("("+this._specialChars+")","g"),this._wordSource={},this._keySource={},this._wordRegexs=[],this._wordKeepReplaces=[],this._textLangs={},this._langs=[],this._cacheNonTranslateText={}};l.prototype.getLanguages=function(){return this._langs},l.prototype.hasLanguage=function(e){return-1!=this._langs.indexOf(e)},l.prototype.insert=function(e){var t,r;for(var n in e){r={source:t=e[n],regexps:{},replaces:{}};for(var o in t){var a=String(t[o]);if(o==s.Key)this._keySource[n]=r;else{var i=a.split("(.+)");if(i.length>1){var d="$1";for(var l in i)d+=i[l]+"$"+(Number(l)+2),i[l]=this.getRegexText(i[l]);r.regexps[o]=this._wordRegexs[a]=new RegExp(this._startRegexStr+i.join("(.+)")+this._endRegexStr,this._modifier),r.replaces[o]=d,console.log(this._startRegexStr+i.join("(.+)")+this._endRegexStr,d)}else r.regexps[o]=this._wordRegexs[a]=new RegExp(this._startRegexStr+this.getRegexText(a)+this._endRegexStr,this._modifier),r.replaces[o]="$1"+a+"$2";this._wordSource[a]=r,this._textLangs[a]=o}u.dev&&(delete this._cacheNonTranslateText[a],delete this._cacheNonTranslateText[n])}}if(t)for(var c in t)c!=s.Key&&-1==this._langs.indexOf(c)&&this._langs.push(c)},l.prototype.getNonTranslate=function(){return this._cacheNonTranslateText},l.prototype.translate=function(e,t){var r=e;if((e=String(e)).length>0){var n=this._wordSource[e];if(n)return n.source[t]||r;var o=this.getTranslateSource(e);if(o)return this.translateBySource(e,o,t)||r}return r},l.prototype.translateByKey=function(e,t){var r,n=this._keySource[e];return n&&(r=n.source[t]||r,n.currentLanguage=t,n.translateText=r,n.currentText=r),r},l.prototype.translateBySource=function(e,t,r){var n=t.dbSource.source[r];if(t.type==d.key)return t.currentLanguage=r,t.translateText=n,t.currentText=n,n;if(void 0!=n)return t.translateText=n,t.currentText=e.replace(t.dbSource.regexps[t.currentLanguage],t.dbSource.replaces[r]),t.currentLanguage=r,t.currentText},l.prototype.getTranslateSource=function(e){var t=this.getTextLanguage(e);if(t){var r=this._wordSource[t.text];if(r)return{type:d.none,translateText:t.text,currentLanguage:t.language,dbSource:r,currentText:e}}},l.prototype.getTranslateSourceByKey=function(e){var t=this._keySource[e];if(t)return{type:d.key,translateText:null,currentLanguage:null,dbSource:t,currentText:null}},l.prototype.getTranslateSourceAndLogByKey=function(e,t){var r=this.getTranslateSourceByKey(e);return u.dev&&void 0==r&&this.setCacheNonTranslate(e,t),r},l.prototype.getTextLanguage=function(e){var t=this._textLangs[e];if(t)return{language:t,text:e};var r=this.getCleanText(e);if(0!=r.length){if(t=this._textLangs[r])return{language:t,text:e};for(var n in this._textLangs)if(this._wordRegexs[n].test(r))return{language:this._textLangs[n],text:n};if(u.dev&&r){var o=r.replace(/[&@#$%^\[\]'"～`~<>,，+-_.。:：;；!！?？{}()=＊*\/\[\]\s\r\n]/g,"");isNaN(Number(o))&&!/^[0-9]+$/.test(o)&&this.setCacheNonTranslate("",r)}}},l.prototype.setCacheNonTranslate=function(e,t){var r={};r[s.Key]=e,r[u.defaultLanguage]=t,this._cacheNonTranslateText[e||t]=r},l.prototype.getCleanText=function(e){return e.replace(this._cleanRegex,"").replace(/(^[\s]+|[\s]+$)/g,"")},l.prototype.getRegexText=function(e){return e.replace(this._textReplaceSpecialCharsRegex,"\\$1")};var c=function(){var e=this;this.watch=!1,this.db=new l,this.currentLanguage=u.defaultLanguage||navigator.language,this.translateTextNodes=new a,this.translatePlaceholderNodes=new o,this.windowAlert=window.alert,this.windowConfirm=window.confirm,this.elementSetAttributeOrigin=Element.prototype.setAttribute,this.proxyAlertHanlder=function(t){e.windowAlert.call(window,e.getText(t))},this.proxyConfirmHanlder=function(t){return e.windowConfirm.call(window,e.getText(t))},this.domNodeInserted=function(t){e.nodeHandler(t.target)},this.domSubtreeModified=function(t){var r=t.target;e.translateTextNodes.need(r)&&e.isNonIgnore(r)&&e.modifyAddNode(e.translateTextNodes,r)}};return c.prototype.isWatch=function(){return this.watch},c.prototype.getTranslateNode=function(){return this.translateTextNodes},c.prototype.getNonTranslateText=function(){return this.db.getNonTranslate()},c.prototype.reload=function(e){if(e)this.db.insert(e);else for(var t in window)-1!=t.indexOf(s.GroupPrefix)&&this.db.insert(window[t]);this.watch&&this.loadTextNodes()},c.prototype.getLanguage=function(){return this.currentLanguage},c.prototype.getText=function(e){return"string"==typeof e?this.db.translate(e,this.currentLanguage):e},c.prototype.getTextByKey=function(e){return this.db.translateByKey(e,this.currentLanguage)},c.prototype.translate=function(e){this.currentLanguage!=e&&this.db.hasLanguage(e)&&(this.currentLanguage=e,this.doTranslate())},c.prototype.start=function(){this.stop(),this.watch=!0,this.reload(),this.doTranslate(),window.alert=this.proxyAlertHanlder,window.confirm=this.proxyConfirmHanlder,Element.prototype.setAttribute=this.buildProxySetAttribute(this),document.addEventListener("DOMNodeInserted",this.domNodeInserted),document.addEventListener("DOMSubtreeModified",this.domSubtreeModified),document.addEventListener("DOMNodeInsertedIntoDocument",this.domNodeInserted)},c.prototype.stop=function(){this.watch=!1,window.alert=this.windowAlert,window.confirm=this.windowConfirm,Element.prototype.setAttribute=this.elementSetAttributeOrigin,document.removeEventListener("DOMNodeInserted",this.domNodeInserted),document.removeEventListener("DOMSubtreeModified",this.domSubtreeModified),document.removeEventListener("DOMNodeInsertedIntoDocument",this.domNodeInserted)},c.prototype.buildProxySetAttribute=function(e){return function(t,r){e.elementSetAttributeOrigin.apply(this,arguments),(t=t.toLowerCase())==s.Translatekey?this.innerText=r:t==s.PlaceholderTranslatekey&&e.addNode(e.translatePlaceholderNodes,this)}},c.prototype.isNonIgnore=function(e){if(e){if(e==document.documentElement)return!0;if(3==e.nodeType&&(e=r.getParentElement(e)),1==e.nodeType)return-1==s.IgnoreTagArray.indexOf(e.tagName)&&(null==e.getAttribute(s.IgnoreAttributeName)&&this.isNonIgnore(r.getParentElement(e)))}return!1},c.prototype.nodeHandler=function(e){this.isNonIgnore(e)&&(this.translateTextNodes.need(e)?this.addNode(this.translateTextNodes,e):this.translatePlaceholderNodes.need(e)&&this.addNode(this.translatePlaceholderNodes,e),this.loopNodes(e.childNodes))},c.prototype.loopNodes=function(e){if(0!=e.length)for(var t=0,r=e.length;t<r;t++)this.nodeHandler(e[t])},c.prototype.loadTextNodes=function(){document.head&&this.nodeHandler(document.head),document.body&&this.nodeHandler(document.body)},c.prototype.doTranslate=function(){this.translateTextNodes.clean();for(var e=this.translateTextNodes.getNodes(),t=0,r=e.length;t<r;t++)this.doTranslateNodesSetText(this.translateTextNodes,e[t]);this.translatePlaceholderNodes.clean();for(var n=0,o=(e=this.translatePlaceholderNodes.getNodes()).length;n<o;n++)this.doTranslateNodesSetText(this.translatePlaceholderNodes,e[n])},c.prototype.addNode=function(e,t){this.updateNode(e,t)||this.addTranslateSource(e,t)&&(this.doTranslateNodesSetText(e,t),e.add(t))},c.prototype.modifyAddNode=function(e,t){this.updateNode(e,t)||this.isCanAddNode(t)&&this.addTranslateSource(e,t)&&(this.doTranslateNodesSetText(e,t),e.add(t))},c.prototype.isCanAddNode=function(e){for(var t=e;(t=r.getParentElement(t))!=document.documentElement;)if(null!=t.getAttribute(s.IgnoreAttributeName))return!1;return!0},c.prototype.updateNode=function(e,t){if(t.translateTextSource){if(t.translateTextSource.currentText==e.getText(t))return!0;if(this.addTranslateSource(e,t))return this.doTranslateNodesSetText(e,t),!0}return!1},c.prototype.addTranslateSource=function(e,t){var n,o;return 3==t.nodeType?(n=r.getParentElement(t).getAttribute(s.Translatekey),o=t.data):void 0!=(n=t.getAttribute(s.Translatekey))&&""!=n?(void 0!=(o=t.innerText)&&""!=o||(o=t.innerText=n),n=void 0):void 0!=(n=t.getAttribute(s.PlaceholderTranslatekey))&&(void 0!=(o=t.getAttribute(s.Placeholder))&&""!=o||(o=n,t.setAttribute(s.Placeholder,n))),void 0!=n?t.translateTextSource=this.db.getTranslateSourceAndLogByKey(n,o):void 0!=(o=e.getText(t))&&0!=String(o).length&&(/^[a-zA-Z0-9_]+$/.test(o)&&(t.translateTextSource=this.db.getTranslateSourceByKey(o),t.translateTextSource)?t.translateTextSource:t.translateTextSource=this.db.getTranslateSource(o))},c.prototype.doTranslateNodesSetText=function(e,t){var r=this.db.translateBySource(e.getText(t),t.translateTextSource,this.currentLanguage);e.setText(t,r)},e.getTranslateGO=t,e.TranslateGO=c,e}({});

var TranslateModule=function(t){"use strict";function e(t,e){function n(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var n=function(){function t(){this._specialChars="[.。:：;；!！?？{}()=＊*/\\[\\]\\s\\r\\n]",this._startRegexStr="("+this._specialChars+"|^)",this._endRegexStr="("+this._specialChars+"|$)",this._cleanChars="[\\r\\n]",this._modifier="i",this._cleanRegex=new RegExp(this._cleanChars+"+","g"),this._textReplaceSpecialCharsRegex=new RegExp("("+this._specialChars+")","g"),this._wordSource={},this._keySource={},this._wordRegexs=[],this._textLanguageData={},this._langs=[],this._cacheNonTranslateText={}}return t.prototype.getLanguages=function(){return this._langs},t.prototype.hasLanguage=function(t){return-1!=this._langs.indexOf(t)},t.prototype.insert=function(t){var e=this;console.log("_loadLanguageData start");var n,o,a,r=performance.now();for(var i in t){-1==e._langs.indexOf(i)&&e._langs.push(i),a=t[i];for(var s in a)n=a[s],(o=e._keySource[s])||(o=e._keySource[s]={}),o[i]=n,e._wordSource[n]=o,e._wordRegexs[n]=new RegExp(e._startRegexStr+e.getRegexText(n)+e._endRegexStr,e._modifier),e._textLanguageData[n]=i}console.log(this._wordSource,this._wordRegexs,this._textLanguageData),console.log("_loadLanguageData end",performance.now()-r)},t.prototype.getNonTranslate=function(){var t={},e=this._langs.length>0?this._langs:["zh_TW"],n=0;for(var o in e){t[e[o]]={},n=0;for(var a in this._cacheNonTranslateText)t[e[o]][n++]=a}return t},t.prototype.translate=function(t,e){var n=t;if((t=String(t)).length>0){var o=this.getWordSource(t);if(o)return o[e]||n;var a=this.getTranslateSource(t);if(o)return this.translateBySource(t,a,e)||n}return n},t.prototype.translateByKey=function(t,e){var n=t,o=this._keySource[t];return o&&(n=o[e]||n),n},t.prototype.translateBySource=function(t,e,n){var o=e.translateRegexs[e.currentLanguage],a=e.wordSource[n];if(void 0!=a)return e.currentLanguage=n,e.translateText=a,e.currentText=t.replace(o,"$1"+a+"$2"),e.currentText},t.prototype.getTranslateSource=function(t){var e=this.getTextLanguage(t);if(e){var n={},o=this.getWordSource(e.text);if(o){for(var a in o)n[a]=this.getWordRegex(o[a]);return{translateText:e.text,currentLanguage:e.language,wordSource:o,translateRegexs:n,currentText:t}}}},t.prototype.getTextLanguage=function(t){var e=this._textLanguageData[t];if(e)return{language:e,text:t};var n=this.getCleanText(t);if(0!=n.length){if(e=this._textLanguageData[n])return{language:e,text:n};for(var o in this._textLanguageData)if(this.getWordRegex(o).test(n))return{language:this._textLanguageData[o],text:o};if(n){var a=n.replace(/[-.。:：;；!！?？{}()=＊*\/\[\]\s\r\n]/g,"");isNaN(Number(a))&&!/^[a-zA-Z]+$/.test(a)&&(console.log(a),this._cacheNonTranslateText[a]=!1)}}},t.prototype.getWordSource=function(t){return this._wordSource[t]},t.prototype.getWordRegex=function(t){return this._wordRegexs[t]},t.prototype.getCleanText=function(t){return t?t.replace(this._cleanRegex,"").replace(/(^[\s]+|[\s]+$)/g,""):t},t.prototype.getRegexText=function(t){return t.replace(this._textReplaceSpecialCharsRegex,"\\$1")},t}(),o=function(){function t(){this._nodes=[]}return t.prototype.indexOf=function(t){return this._nodes.indexOf(t)},t.prototype.getNodes=function(){return this._nodes},t.prototype.add=function(t){this._nodes.push(t)},t.prototype.remove=function(t){var e=this.indexOf(t);return-1!=e&&(this._nodes.splice(e,1),!0)},t.prototype.clean=function(){this._nodes=this._nodes.filter(this.cleanFilterHandler)},t.prototype.cleanFilterHandler=function(t){return t&&t.isConnected},t}(),a=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return e(n,t),n.prototype.need=function(t){return 3==t.nodeType},n.prototype.getText=function(t){return t.data},n.prototype.setText=function(t,e){e&&(t.data=e)},n}(o),r=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return e(n,t),n.prototype.need=function(t){return("INPUT"==t.tagName||"TEXTAREA"==t.tagName)&&t.placeholder},n.prototype.getText=function(t){return t.placeholder},n.prototype.setText=function(t,e){e&&(t.placeholder=e)},n}(o),i=function(){return function(t){var e=this;this.translateGO=t,this.toolUrl="https://babyblue94520.github.io/translate-go-tool/dist/#/Index",this.toolOrigin="https://babyblue94520.github.io",this.start=function(t){e.translateGO.watch(),e.status(!0)},this.stop=function(t){e.translateGO.stop(),e.status(!1)},this.languageChange=function(t){e.translateGO.translate(e._languageSelect.value)},this.openTool=function(t){!e.toolWindow||e.toolWindow.closed?(e.toolWindow=window.open(e.toolUrl,e.toolOrigin),setTimeout(function(){e.toolWindow.postMessage(e.translateGO.getNonTranslateText(),e.toolOrigin)},2e3)):e.toolWindow.focus()},this.postNonText=function(t){e.toolWindow&&(e.toolWindow.postMessage(e.translateGO.getNonTranslateText(),e.toolOrigin),e.toolWindow.focus())},this.status=function(t){t?(e._startWatchButton.disabled=!0,e._stopWatchButton.disabled=!1):(e._startWatchButton.disabled=!1,e._stopWatchButton.disabled=!0)},this.updateLanaguageOption=function(t){if(e._languageSelect){console.log(e._languageSelect.value),e._languageSelect.innerHTML="";var n=void 0,o=void 0;for(var a in t)o=t[a],(n=document.createElement("option")).value=o,n.innerText=o,e._languageSelect.appendChild(n)}},this.changeLanaguage=function(t){e._languageSelect.value=t};var n=document.createElement("style");n.innerHTML=[".translate-toolbar{","position: fixed;z-index: 999;bottom: 0px;left: 0;","}",".translate-toolbar>button,.translate-toolbar>select{","padding: 10px;margin: 5px;display: inline-block; box-shadow: rgba(0, 0, 0, 0.25) 0px 5px 15px, rgba(0, 0, 0, 0.22) 0px 3px 10px;","}",".translate-toolbar>button:disabled,.translate-toolbar>select:disabled{","background-color:#fff;color:#ccc;","box-shadow: rgba(0, 0, 0, 0.25) 0px 1px 1px","}"].join(""),document.head.appendChild(n),this._element=document.createElement("div"),this._element.className="translate-toolbar",this._languageSelect=document.createElement("select"),this._languageSelect.addEventListener("change",this.languageChange),this._startWatchButton=document.createElement("button"),this._startWatchButton.innerText="start",this._startWatchButton.addEventListener("click",this.start),this._stopWatchButton=document.createElement("button"),this._stopWatchButton.innerText="stop",this._stopWatchButton.addEventListener("click",this.stop),this._openToolWindowButton=document.createElement("button"),this._openToolWindowButton.innerText="open",this._openToolWindowButton.addEventListener("click",this.openTool),this._postNonTextButton=document.createElement("button"),this._postNonTextButton.innerText="post",this._postNonTextButton.addEventListener("click",this.postNonText),this._element.appendChild(this._languageSelect),this._element.appendChild(this._startWatchButton),this._element.appendChild(this._stopWatchButton),this._element.appendChild(this._openToolWindowButton),this._element.appendChild(this._postNonTextButton),document.body?document.body.appendChild(this._element):window.onload=function(t){document.body.appendChild(e._element)}}}(),s=function(){function t(t,e){var o=this;this._db=new n,this._cacheInputElement=[],this._translateTextNodes=new a,this._translatePlaceholderNodes=new r,this._ignoreTagArray=["SCRIPT","LINK","META","STYLE"],this._temp=[],this.windowAlert=window.alert,this.windowConfirm=window.confirm,this.delayAction=function(){var t={},e={};return function(n,o,a){t[n]?clearTimeout(t[n]):e[n]=performance.now(),t[n]=setTimeout(function(){console.log(n,"delay time:",performance.now()-e[n]),e[n]=performance.now(),a(),console.log(n,"run time:",performance.now()-e[n]),delete t[n],delete e[n]},o)}}(),this.addListener=function(){window.alert=o.proxyAlertHanlder,window.confirm=o.proxyConfirmHanlder,document.addEventListener("DOMNodeInserted",o.delayDOMNodeInserted),document.addEventListener("DOMSubtreeModified",o.delayDOMSubtreeModified),document.addEventListener("DOMNodeInsertedIntoDocument",o.delayDOMNodeInserted)},this.proxyAlertHanlder=function(t){console.log(o.windowAlert),o.windowAlert.call(window,o.getText(t))},this.proxyConfirmHanlder=function(t){return o.windowConfirm.call(window,o.getText(t))},this.delayDOMNodeInserted=function(t){o.nodeHandler(t.target)},this.delayDOMSubtreeModified=function(t){o._translateTextNodes.need(t.target)&&o.addNode.call(o,o._translateTextNodes,t.target)},this._currentLanguage=t||navigator.language,e&&(this.toolbar=new i(this),this.toolbar.updateLanaguageOption(this._db.getLanguages()),this.toolbar.changeLanaguage(this._currentLanguage))}return t.prototype.getTranslateNode=function(){return this._translateTextNodes},t.prototype.getNonTranslateText=function(){return this._db.getNonTranslate()},t.prototype.loadLanguageData=function(t){this._db.insert(t),this.toolbar&&(this.toolbar.updateLanaguageOption(this._db.getLanguages()),this.toolbar.changeLanaguage(this._currentLanguage)),this.loadTextNodes()},t.prototype.getLanguage=function(){return this._currentLanguage},t.prototype.getText=function(t){return"string"==typeof t?this._db.translate(t,this._currentLanguage):t},t.prototype.getTextByKey=function(t){return this._db.translateByKey(t,this._currentLanguage)},t.prototype.translate=function(t){if(this._currentLanguage!=t&&this._db.hasLanguage(t)){var e=performance.now();console.log("_doTranslate start"),this._currentLanguage=t,this.doTranslate(),console.log("_doTranslate end",performance.now()-e),this.toolbar&&this.toolbar.changeLanaguage(this._currentLanguage)}},t.prototype.watch=function(){this.stop(),console.log("find text node start");var t=performance.now();this.loadTextNodes(),console.log("find text node end",performance.now()-t),this.doTranslate(),this.addListener(),this.toolbar&&this.toolbar.status(!0)},t.prototype.stop=function(){window.alert=this.windowAlert,window.confirm=this.windowConfirm,document.removeEventListener("DOMNodeInserted",this.delayDOMNodeInserted),document.removeEventListener("DOMSubtreeModified",this.delayDOMSubtreeModified),document.removeEventListener("DOMNodeInsertedIntoDocument",this.delayDOMNodeInserted),this.toolbar&&this.toolbar.status(!1)},t.prototype.isNonIgnore=function(t){return-1==this._ignoreTagArray.indexOf(t.tagName)},t.prototype.nodeHandler=function(t){if(t&&this.isNonIgnore(t)&&t.isConnected){if(this._translateTextNodes.need(t))return void this.addNode.call(this,this._translateTextNodes,t);if(this._translatePlaceholderNodes.need(t))return void this.addNode.call(this,this._translatePlaceholderNodes,t);this.loopNodes(t.childNodes)}},t.prototype.loopNodes=function(t){for(var e=0,n=t.length;e<n;e++)this.nodeHandler(t[e])},t.prototype.loadTextNodes=function(){this.loopNodes(document.querySelectorAll("*"))},t.prototype.doTranslate=function(){this._translateTextNodes.clean();for(var t=this._translateTextNodes.getNodes(),e=0,n=t.length;e<n;e++)this.doTranslateNodesSetText(this._translateTextNodes,t[e])},t.prototype.doTranslateNodesSetText=function(t,e){t.setText(e,this._db.translateBySource(t.getText(e),e.translateTextSource,this._currentLanguage))},t.prototype.addNode=function(t,e){if(e.translateTextSource){t.getText(e);e.translateTextSource.currentText!=t.getText(e)&&(this.addTranslateSource(t,e),this.doTranslateNodesSetText(t,e))}else this.addTranslateSource(t,e)&&(t.add(e),this.doTranslateNodesSetText(t,e))},t.prototype.addTranslateSource=function(t,e){var n=t.getText(e);return void 0!=n&&0!=String(n).length&&(e.translateTextSource=this._db.getTranslateSource(n))},t}();return t.TranslateGO=s,t}({});
